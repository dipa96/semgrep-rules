rules:
  - id: dom_vuln_finder
    message: |
      dom dom dom, who is?
    severity: ERROR
    languages:
      - JavaScript
    metadata:
      authors:
        - Donato Di Pasquale (@dipa996) (@ertataki) (@ddipa) 
      category: security
      references:
        - https://owasp.org/www-community/attacks/DOM_Based_XSS
    mode: taint
    pattern-sources:
    # A source is a JavaScript property that accepts data that is potentially attacker-controlled.
      - patterns:
        - pattern-either:
          - pattern: location
          - pattern: window.location
          - pattern: document.location
          - pattern: document.URL
          - pattern: window.name
          - pattern: document.referrer
          - pattern: document.documentURI
          - pattern: document.baseURI
          - pattern: document.cookie
          - pattern: JSON.parse
          - pattern: $PARAM.data

      - pattern-either:
      # Patterns for functions
        - patterns:
          - pattern-inside: |
                $ACTION($FUNC(...))  
        - patterns:
          - pattern-inside: |
              function $FUNC(..., $PARAM, ...) {
                ...
              }
          - pattern: $PARAM
        - patterns:
          - pattern-inside: |
               function $FUNC(...) {
                 ...
               }


    # Propagators - SemGrep ()
    pattern-propagators:
    # Aggiunge parametro/valore all'elemento
    - pattern: $T.push($F)
      from: $F
      to: $T
    # Ritorna il parametro eliminato dall'elemento
    - pattern: $T.shift($F)
      from: $F
      to: $T
    # Ritorna l'elemento completo pi√π il parametro passato
    - pattern: $T.unshift($F)
      from: $F
      to: $T


    pattern-sinks:
    # A sink is a potentially dangerous JavaScript function or DOM object that can cause undesirable effects if attacker-controlled data is passed to it
      - patterns:
        - pattern-either:
        # Commons Sinks
          - pattern: eval(...)
          - pattern: Function(...)
          - pattern: execScript(...)
          - pattern: setTimeout(...)
          - pattern: setInterval(...)
          - pattern: setImmediate(...)
          - pattern: msSetImmediate(...)
          - pattern: document.write(...)
          - pattern: document.writeln(...)
          - pattern: JSON.parse(...)
          # Sinks variant
          - pattern: document.domain = $PARAM
          - pattern: location = $PARAM
          - pattern: location.href = $PARAM
          - pattern: location.replace = $PARAM
          - pattern: location.assign = $PARAM
          # Unsafe method/property
          - pattern: $ELEMENT.innerHTML = $PARAM
          - pattern: $ELEMENT.outerHTML = $PARAM
          - pattern: $ELEMENT.src = $PARAM
          - pattern: $ELEMENT.srcdoc = $PARAM
          - pattern: $ELEMENT.textContent = $PARAM
          - pattern: $ELEMENT.text = $PARAM
          - pattern: $ELEMENT.innerText = $PARAM
          - pattern: $ELEMENT.appendChild = $PARAM
          - pattern: $ELEMENT.appendChild(...)
          - pattern: $ELEMENT.append = $PARAM
          - pattern: $ELEMENT.open(...)
          - pattern: $ELEMENT.insertAdjacentHTML(...)
          # JQuery Area
          - pattern: $(...)
          - pattern: $JQ.$(...)
          - pattern: $JQ.parseHTML(...)
          - pattern: $JQ.add(...)
          - pattern: $JQ.html(...)
          - pattern: $JQ.globalEval(...)
          - pattern: $JQ.has(...)
          - pattern: $JQ.index(...)
          - pattern: $JQ.append(...)
          - pattern: $JQ.appendTo(...)
          - pattern: $JQ.after(...)
          - pattern: $JQ.insertAfter(...)
          - pattern: $JQ.before(...)
          - pattern: $JQ.insertBefore(...)
          - pattern: $JQ.prepend(...)
          - pattern: $JQ.prependTo(...)
          - pattern: $JQ.replaceWith(...)
          - pattern: $JQ.replaceAll(...)
          - pattern: $JQ.wrap(...)
          - pattern: $JQ.wrapAll(...)
          - pattern: $JQ.wrapInner(...)
          - pattern: $JQ.prop.innerHTML(...)
          - pattern: $JQ.prop.outerHTML(...)
        
        
        # Avoid False Positive(FP)
        - pattern-not: $ELEMENT.$PROPERTY = "..."
        - pattern-not: $ELEMENT.$PROPERTY += "..."


    # Sanitizers
    pattern-sanitizers:
      - pattern: DOMPurify.sanitize(...)