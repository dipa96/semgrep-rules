rules:
  - id: dom_vuln_finder 
    message: |
      dom dom dom, who is?
    severity: ERROR
    languages:
      - JavaScript
    metadata:
      authors:
        - Donato Di Pasquale (@dipa996) (@ertataki) (@ddipa) 
      category: security
      references:
        - https://owasp.org/www-community/attacks/DOM_Based_XSS
    mode: taint
    pattern-sources:
    # A source is a JavaScript property that accepts data that is potentially attacker-controlled.
        - pattern-either:
            - patterns:
              - pattern-inside: |
                  $METHOD($FUNC(...,$PARAM,...))
              - pattern: $PARAM
            - patterns:
              - pattern-inside: |
                  $METHOD($FUNC()) {
                    ...
                  }
            - patterns:
              - pattern-inside: |
                  function $FUNC(..., $PARAM, ...) {
                    ...
                  }
              - pattern: $PARAM
            - patterns:
              - pattern-inside: |
                  function $FUNC(...) {
                  ...
                  }

        - pattern-either:
          - pattern: location
          - pattern: window.location
          - pattern: document.location
          - pattern: document.URL
          - pattern: window.name
          - pattern: document.referrer
          - pattern: document.documentURI
          - pattern: document.baseURI
          - pattern: document.cookie
          - pattern: localStorage.getItem
          - pattern: sessionStorage.getItem
          # Make sense JSON.parse in sources?
          # - pattern: JSON.parse
          - pattern: $OBJECT.data
          


    # Propagators - SemGrep ()
    pattern-propagators:
    # The push() method adds the specified elements to the end of an array and returns the new length of the array.
    - pattern: $T.push($F)
      from: $F
      to: $T
    # The shift() method removes the element at the zeroth index and shifts the values at consecutive indexes down, then returns the removed value.
    - pattern: $T.shift($F)
      from: $F
      to: $T
    #  The unshift() method adds the specified elements to the beginning of an array and returns the new length of the array.
    - pattern: $T.unshift($F)
      from: $F
      to: $T


    pattern-sinks:
    # A sink is a potentially dangerous JavaScript function or DOM object that can cause undesirable effects if attacker-controlled data is passed to it
      - patterns:
        - pattern-either:
        # Commons Sinks
          - pattern: eval(...)
          - pattern: Function(...)
          - pattern: execScript(...)
          - pattern: setTimeout(...)
          - pattern: setInterval(...)
          - pattern: setImmediate(...)
          - pattern: msSetImmediate(...)
          - pattern: document.write(...)
          - pattern: document.writeln(...)
          # JSON.parse may cause false positives (FP) and not perform very well in sinks area
          # - pattern: JSON.parse(...)
          # Sinks variant
          - pattern: document.domain = $PARAM
          - pattern: location = $PARAM
          - pattern: location.href = $PARAM
          - pattern: location.replace(...)
          - pattern: location.assign(...)
          # Unsafe method/property
          - pattern: $ELEMENT.innerHTML = $PARAM
          - pattern: $ELEMENT.outerHTML = $PARAM
          - pattern: $ELEMENT.src = $PARAM
          - pattern: $ELEMENT.srcdoc = $PARAM
          - pattern: $ELEMENT.textContent = $PARAM
          - pattern: $ELEMENT.text = $PARAM
          - pattern: $ELEMENT.innerText = $PARAM
          - pattern: $ELEMENT.appendChild = $PARAM
          - pattern: $ELEMENT.appendChild(...)
          - pattern: $ELEMENT.append = $PARAM
          - pattern: $ELEMENT.open(...)
          - pattern: $ELEMENT.insertAdjacentHTML(...)
          # JQuery Area
          # May False Positive(FP) with JQuery Selector , How to create a better rule?
          - pattern: $(...)
          - pattern: $JQ.$(...)
          - pattern: $JQ.parseHTML(...)
          - pattern: $JQ.add(...)
          - pattern: $JQ.html(...)
          - pattern: $JQ.globalEval(...)
          - pattern: $JQ.has(...)
          - pattern: $JQ.index(...)
          - pattern: $JQ.append(...)
          - pattern: $JQ.appendTo(...)
          - pattern: $JQ.after(...)
          - pattern: $JQ.insertAfter(...)
          - pattern: $JQ.before(...)
          - pattern: $JQ.insertBefore(...)
          - pattern: $JQ.prepend(...)
          - pattern: $JQ.prependTo(...)
          - pattern: $JQ.replaceWith(...)
          - pattern: $JQ.replaceAll(...)
          - pattern: $JQ.wrap(...)
          - pattern: $JQ.wrapAll(...)
          - pattern: $JQ.wrapInner(...)
          - pattern: $JQ.prop.innerHTML(...)
          - pattern: $JQ.prop.outerHTML(...)
        
        
        # Avoid False Positive(FP)
        - pattern-not: $ELEMENT.$PROPERTY = "..."
        - pattern-not: $ELEMENT.$PROPERTY += "..."
        - pattern-not: $ELEMENT.$PROPERTY("...")

    # Sanitizers
    pattern-sanitizers:
      - pattern: DOMPurify.sanitize(...)