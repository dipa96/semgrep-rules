rules:
  - id: input-to-unsafe-dom-param
    message: |
      dom dom dom, who is?
    severity: ERROR
    languages:
      - JavaScript
      - TypeScript
    metadata:
      authors:
        - Donato Di Pasquale (@dipa996) (@ertataki) (@ddipa) 
      category: security
      references:
        - https://owasp.org/www-community/attacks/DOM_Based_XSS
    mode: taint
    pattern-sources:
      - patterns:
        - pattern-either:
        # Javascript Sources
          - pattern: location
          - pattern: window.location
          - pattern: document.location
          - pattern: document.URL
          - pattern: window.name
          - pattern: document.referrer
          - pattern: document.documentURI
          - pattern: document.baseURI
          - pattern: document.cookie
      - pattern-either:
      # Pattern di Funzione 1
        - patterns:
          - pattern-inside: |
              function $FUNC(..., $PARAM, ...) {
                ...
              }
          - pattern: $PARAM
        - patterns:
        # Pattern di funzione 2
          - pattern-inside: |
              function $FUNC(...) {
                ...
              }
    # mamma mia come spingono i propagators fortissimi <3
    pattern-propagators:
    # Aggiunge parametro/valore all'elemento
    - pattern: $T.push($F)
      from: $F
      to: $T
    # Ritorna il parametro eliminato dall'elemento
    - pattern: $T.shift($F)
      from: $F
      to: $T
    # Ritorna l'elemento completo più il parametro passato
    - pattern: $T.unshift($F)
      from: $F
      to: $T

    pattern-sinks:
      - patterns:
        - pattern-either:
          # Javascript Sinks
          - pattern: eval(...)
          - pattern: Function(...)
          - pattern: execScript(...)
          - pattern: setTimeout(...)
          - pattern: setInterval(...)
          - pattern: setImmediate(...)
          - pattern: msSetImmediate(...)
          - pattern: document.write(...)
          - pattern: document.writeln(...)
          # Sinks variant
          - pattern: document.domain = $PARAM
          - pattern: location = $PARAM
          - pattern: location.href = $PARAM
          - pattern: location.replace = $PARAM
          - pattern: location.assign = $PARAM
          # Quando viene utilizzato un metodo unsafe ed il valore è controllato da noi, genera troppi falsi positivi
          - pattern: $ELEMENT.innerHTML = $PARAM
          - pattern: $ELEMENT.outerHTML = $PARAM
          - pattern: $ELEMENT.src = $PARAM
          - pattern: $ELEMENT.srcdoc = $PARAM
          - pattern: $ELEMENT.textContent = $PARAM
          - pattern: $ELEMENT.text = $PARAM
          - pattern: $ELEMENT.innerText = $PARAM
          - pattern: $ELEMENT.appendChild = $PARAM
          - pattern: $ELEMENT.append = $PARAM
          - pattern: $ELEMENT.open(...)
          - pattern: $ELEMENT.insertAdjacentHTML(...)
          # JQuery Area, in realtà non c'è bisogno di specificare, l'ho fatto solo per ordinare meglio le sinks
          - pattern: $(...)
          - pattern: $JQ.$(...)
          # - pattern: $JQ.constructor(...) # Ho capito a metà, non lo trovo in documentazione
          - pattern: $JQ.parseHTML(...)
          - pattern: $JQ.add(...)
          - pattern: $JQ.html(...)
          - pattern: $JQ.globalEval(...)
          - pattern: $JQ.has(...)
          # - pattern: $JQ.init(...) NotFound in Docs
          - pattern: $JQ.index(...)
          - pattern: $JQ.append(...)
          - pattern: $JQ.appendTo(...)
          - pattern: $JQ.after(...)
          - pattern: $JQ.insertAfter(...)
          - pattern: $JQ.before(...)
          - pattern: $JQ.insertBefore(...)
          - pattern: $JQ.prepend(...)
          - pattern: $JQ.prependTo(...)
          - pattern: $JQ.replaceWith(...)
          - pattern: $JQ.replaceAll(...)
          - pattern: $JQ.wrap(...)
          - pattern: $JQ.wrapAll(...)
          - pattern: $JQ.wrapInner(...)
          - pattern: $JQ.prop.innerHTML(...)
          - pattern: $JQ.prop.outerHTML(...)
        
          
    # Non sono sicuro di voler lasciare i sanitizers
    pattern-sanitizers:
      - pattern: DOMPurify.sanitize(...)